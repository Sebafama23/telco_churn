name: Continuous Deployment (CD) - Model Promotion

on:
  push:
    branches: [ main ] # Se dispara solo despu茅s de un merge en main

jobs:
  promote-model:
    runs-on: ubuntu-latest
    
    steps:
      - name: 锔 Checkout repository
        uses: actions/checkout@v4
        
      - name:  Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name:  Install MLflow & DagsHub
        run: pip install mlflow dagshub

      #  Configuraci贸n de MLflow para DagsHub
      - name:  Configure MLflow Tracking
        env:
          MLFLOW_TRACKING_URI: https://dagshub.com/Sebafama23/telco_churn.mlflow
          MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
        run: |
          # Exportar credenciales para que el script de Python las use
          echo "MLFLOW_TRACKING_URI=${{ env.MLFLOW_TRACKING_URI }}" >> $GITHUB_ENV
          echo "MLFLOW_TRACKING_USERNAME=${{ env.MLFLOW_TRACKING_USERNAME }}" >> $GITHUB_ENV
          echo "MLFLOW_TRACKING_PASSWORD=${{ env.MLFLOW_TRACKING_PASSWORD }}" >> $GITHUB_ENV

      #  Paso CD: Promocionar el 煤ltimo modelo registrado a Production
      - name:  Promote Model to Production
        run: |
          python -c "
import mlflow
client = mlflow.tracking.MlflowClient()
# Obtener la versi贸n m谩s reciente del modelo 'TelcoChurnModel'
latest_version = client.get_latest_versions('TelcoChurnModel', stages=['None'])[0]
# Promover la versi贸n m谩s reciente a la etapa 'Production'
client.transition_model_version_stage(
    name='TelcoChurnModel',
    version=latest_version.version,
    stage='Production',
    archive_existing_versions=True
)
print(f'Modelo TelcoChurnModel versi贸n {latest_version.version} promovido a Production.')
"