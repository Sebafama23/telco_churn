name: DVC CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    
    steps:
    - name: ‚öôÔ∏è Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: üêç Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: üì¶ Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install "dvc[all]" mlflow dagshub

    # 1Ô∏è‚É£ CONFIGURACI√ìN DVC (Para pull/push de datos grandes)
    - name: üîë Configure DVC remote
      env:
        DAGSHUB_USER: ${{ secrets.DAGSHUB_USERNAME }}
        DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      run: |
        # Configurar DVC para usar la autenticaci√≥n b√°sica con usuario/token
        dvc remote modify dagshub-storage --local auth basic
        dvc remote modify dagshub-storage --local user "$DAGSHUB_USER"
        dvc remote modify dagshub-storage --local password "$DAGSHUB_TOKEN"
        
    # 2Ô∏è‚É£ CONFIGURACI√ìN MLFLOW (Para tracking de experimentos)
    - name: üîë Configure MLflow Tracking
      env:
        MLFLOW_TRACKING_URI: https://dagshub.com/Sebafama23/telco_churn.mlflow
        MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
        MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
        # üö® NUEVAS VARIABLES CLAVE üö®
        MLFLOW_TRACKING_TOKEN: ${{ secrets.DAGSHUB_TOKEN }} # Usar token expl√≠citamente
        MLFLOW_TRACKING_HOST: https://dagshub.com/
      run: |
        # ... (resto del c√≥digo de exportaci√≥n)


    - name: ‚¨áÔ∏è Pull data
      # El pull deber√≠a funcionar ya que el hash es NUEVO
      run: dvc pull --force

    - name: üë§ Configure Git User Identity
      run: |
        git config --global user.email "ci-runner@github.com"
        git config --global user.name "GitHub CI Runner"

    # 2Ô∏è‚É£ PASO MODIFICADO (para que el commit funcione)
    - name: üßπ Clean Git tracking
      run: |
        # A√±adimos --ignore-unmatch para que no falle si el archivo ya fue limpiado
        git rm -r --cached --ignore-unmatch models/telco_churn.pkl
        git rm -r --cached --ignore-unmatch metrics.json
        
        # El commit es necesario para guardar el cambio de metadatos (si hubo alguno)
        git commit -m "clean: Stop Git tracking for DVC outputs (model and metrics)"
      
    - name: üöÄ Run pipeline
      # MLflow ahora sabr√° d√≥nde enviar los resultados gracias a las ENV
      run: dvc repro
      
    # 3Ô∏è‚É£ A√ëADIR DVC COMMIT (Mejora: Asegura que los metadatos del repro se rastreen)
    - name: üíæ Commit DVC changes
      run: dvc commit
      
    - name: ‚¨ÜÔ∏è Push changes
      run: dvc push

    - name: üìä Metrics
      run: cat metrics.json