name: DVC CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    
    steps:
    - name: âš™ï¸ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install "dvc[all]" mlflow dagshub

    # 1ï¸âƒ£ CONFIGURACIÃ“N DVC (Para pull/push de datos grandes)
    - name: ğŸ”‘ Configure DVC remote
      env:
        DAGSHUB_USER: ${{ secrets.DAGSHUB_USERNAME }}
        DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
      run: |
        # Configurar DVC para usar la autenticaciÃ³n bÃ¡sica con usuario/token
        dvc remote modify dagshub-storage --local auth basic
        dvc remote modify dagshub-storage --local user "$DAGSHUB_USER"
        dvc remote modify dagshub-storage --local password "$DAGSHUB_TOKEN"
        
    # 2ï¸âƒ£ CONFIGURACIÃ“N MLFLOW (Para tracking de experimentos)
    - name: ğŸ”‘ Configure MLflow Tracking to DagsHub
      env:
        # Rutas de DagsHub para MLflow
        MLFLOW_TRACKING_URI: https://dagshub.com/Sebafama23/telco_churn.mlflow # <--- Â¡IMPORTANTE! Reemplaza 'Sebafama23/telco_churn' si es necesario
        MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
        MLFLOW_TRACKING_PASSWORD: ${{ secrets.DAGSHUB_TOKEN }}
      run: |
        echo "MLFLOW_TRACKING_URI=${{ env.MLFLOW_TRACKING_URI }}" >> $GITHUB_ENV
        echo "MLFLOW_TRACKING_USERNAME=${{ env.MLFLOW_TRACKING_USERNAME }}" >> $GITHUB_ENV
        echo "MLFLOW_TRACKING_PASSWORD=${{ env.MLFLOW_TRACKING_PASSWORD }}" >> $GITHUB_ENV


    - name: â¬‡ï¸ Pull data
      # El pull deberÃ­a funcionar ya que el hash es NUEVO
      run: dvc pull --force

    - name: ğŸ‘¤ Configure Git User Identity
      run: |
        git config --global user.email "ci-runner@github.com"
        git config --global user.name "GitHub CI Runner"

    # 2ï¸âƒ£ PASO MODIFICADO (para que el commit funcione)
    - name: ğŸ§¹ Clean Git tracking
      run: |
        git rm -r --cached models/telco_churn.pkl
        git commit -m "clean: Stop Git tracking for model file managed by DVC"
      
    - name: ğŸš€ Run pipeline
      # MLflow ahora sabrÃ¡ dÃ³nde enviar los resultados gracias a las ENV
      run: dvc repro
      
    # 3ï¸âƒ£ AÃ‘ADIR DVC COMMIT (Mejora: Asegura que los metadatos del repro se rastreen)
    - name: ğŸ’¾ Commit DVC changes
      run: dvc commit
      
    - name: â¬†ï¸ Push changes
      run: dvc push

    - name: ğŸ“Š Metrics
      run: cat metrics.json